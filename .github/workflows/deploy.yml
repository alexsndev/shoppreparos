name: Simple FTP Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: deploy-production
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      FTP_HOST: ${{ secrets.FTP_HOST }}
      FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
      FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
      FTP_REMOTE_DIR: ${{ secrets.FTP_REMOTE_DIR }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Definir diretório alvo
        run: |
          : "${FTP_HOST:?Secret FTP_HOST ausente}"
          : "${FTP_USERNAME:?Secret FTP_USERNAME ausente}"
          : "${FTP_PASSWORD:?Secret FTP_PASSWORD ausente}"
          if [ -z "$FTP_REMOTE_DIR" ]; then
            echo "Sem FTP_REMOTE_DIR -> usando /laravel"
            echo "FTP_TARGET_DIR=/laravel/" >> $GITHUB_ENV
          else
            case "$FTP_REMOTE_DIR" in
              */) echo "FTP_TARGET_DIR=$FTP_REMOTE_DIR" >> $GITHUB_ENV ;;
              *) echo "FTP_TARGET_DIR=${FTP_REMOTE_DIR}/" >> $GITHUB_ENV ;;
            esac
          fi
          echo "Diretório remoto final: $(grep FTP_TARGET_DIR= $GITHUB_ENV | cut -d= -f2)"

      - name: FTP Deploy (apenas pasta laravel na raiz)
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ env.FTP_HOST }}
          username: ${{ env.FTP_USERNAME }}
          password: ${{ env.FTP_PASSWORD }}
          protocol: ftp
          server-dir: ${{ env.FTP_TARGET_DIR }}
          timeout: 120000
          exclude: |
            **/.git*
            **/.github/**
            **/node_modules/**
            **/tests/**
            **/storage/logs/**
            **/storage/framework/cache/data/**
            **/.env.example
            **/.env.local
          log-level: standard
